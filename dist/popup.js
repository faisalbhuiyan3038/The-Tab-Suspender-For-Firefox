function applyTheme(e){document.documentElement.setAttribute("data-theme",e?"dark":"light")}function setupTabs(){const e=document.querySelectorAll(".tab"),t=document.querySelectorAll(".tab-content");e.forEach(n=>{n.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active")),t.forEach(e=>e.classList.remove("active")),n.classList.add("active");const i=n.getAttribute("data-tab");document.getElementById(`${i}-tab`).classList.add("active")})})}function formatUrl(e){try{const t=new URL(e);return{display:`${t.hostname}${"/"===t.pathname?"":t.pathname}`,full:e}}catch(t){return{display:e,full:e}}}function displayWhitelist(e,t){const n=document.getElementById("whitelist");n.innerHTML="";const i=Array.isArray(e)?e:[],s=Array.isArray(t)?t:[];if(0===i.length&&0===s.length)return void(n.innerHTML='<p class="no-items">No whitelisted items</p>');const a=document.createElement("div");if(a.className="whitelist-section",a.innerHTML="<h4>Whitelisted Domains</h4>",i.length>0)i.forEach(e=>{const t=document.createElement("div");t.className="whitelist-item",t.innerHTML=`\n        <span title="${e}">${e}</span>\n        <button class="remove-btn" data-type="domain" data-value="${e}">×</button>\n      `,a.appendChild(t)});else{const e=document.createElement("p");e.className="no-items",e.textContent="No domains whitelisted",a.appendChild(e)}n.appendChild(a);const o=document.createElement("div");if(o.className="whitelist-section",o.innerHTML="<h4>Whitelisted Pages</h4>",s.length>0)s.forEach(e=>{const t=formatUrl(e),n=document.createElement("div");n.className="whitelist-item",n.innerHTML=`\n        <span title="${t.full}">${t.display}</span>\n        <button class="remove-btn" data-type="url" data-value="${e}">×</button>\n      `,o.appendChild(n)});else{const e=document.createElement("p");e.className="no-items",e.textContent="No pages whitelisted",o.appendChild(e)}n.appendChild(o)}function showMainStatus(e="Settings saved!"){const t=document.getElementById("status");t&&(window.statusTimeout&&clearTimeout(window.statusTimeout),t.classList.remove("visible"),t.offsetWidth,t.textContent=e,t.classList.add("visible"),window.statusTimeout=setTimeout(()=>{t.classList.remove("visible")},2e3))}const SYNC_SETTINGS_KEYS=["suspendTime","isEnabled","ignoreAudio","ignoreFormInput","ignoreNotifications","ignorePinned","whitelistedDomains","whitelistedUrls","enableScreenshots","captureQuality","resizeWidth","resizeHeight","resizeQuality"];async function loadAndDisplaySettings(){try{const[e,t]=await Promise.all([chrome.storage.sync.get(SYNC_SETTINGS_KEYS),chrome.storage.local.get(["darkMode"])]),n={...e,...t},i=40,s=n.suspendTime||i,a=n.isEnabled??!0;document.getElementById("suspendTime").value=s,document.getElementById("enableSwitch").checked=a,document.getElementById("ignoreAudio").checked=n.ignoreAudio??!0,document.getElementById("ignoreFormInput").checked=n.ignoreFormInput??!0,document.getElementById("ignoreNotifications").checked=n.ignoreNotifications??!0,document.getElementById("ignorePinned").checked=n.ignorePinned??!0,document.getElementById("darkModeSwitch").checked=n.darkMode??!1,document.getElementById("enableScreenshots").checked=n.enableScreenshots??!1,document.getElementById("captureQuality").value=n.captureQuality||50,document.getElementById("resizeWidth").value=n.resizeWidth||1280,document.getElementById("resizeHeight").value=n.resizeHeight||720,document.getElementById("resizeQuality").value=n.resizeQuality||.5,applyTheme(n.darkMode??!1);const o=n.whitelistedDomains||[];displayWhitelist(o,n.whitelistedUrls||[]),setupTabs()}catch(e){console.error("Error loading settings:",e)}}async function getCurrentTab(){return(await chrome.tabs.query({active:!0,currentWindow:!0}))[0]}document.addEventListener("DOMContentLoaded",loadAndDisplaySettings),document.getElementById("whitelist").addEventListener("click",async e=>{if(e.target.classList.contains("remove-btn")){const t=e.target.dataset.type,n=e.target.dataset.value,i=await chrome.storage.sync.get(["whitelistedDomains","whitelistedUrls"]),s="domain"===t?"whitelistedDomains":"whitelistedUrls",a=(i[s]||[]).filter(e=>e!==n);await chrome.storage.sync.set({[s]:a});displayWhitelist("domain"===t?a:i.whitelistedDomains||[],"url"===t?a:i.whitelistedUrls||[]),showMainStatus("Whitelist updated")}}),document.getElementById("enableSwitch").addEventListener("change",e=>{const t=e.target.checked;chrome.storage.sync.set({isEnabled:t}),showMainStatus()}),document.getElementById("darkModeSwitch").addEventListener("change",e=>{const t=e.target.checked;chrome.storage.local.set({darkMode:t}),applyTheme(t),chrome.runtime.sendMessage({action:"updateTheme",isDark:t}),showMainStatus()}),document.getElementById("saveOptionsButton").addEventListener("click",()=>{try{const e=parseInt(document.getElementById("suspendTime").value,10);if(isNaN(e)||e<1||e>1440)return void showMainStatus("Time must be between 1 and 1440");const t={suspendTime:e,enableScreenshots:document.getElementById("enableScreenshots").checked,ignoreAudio:document.getElementById("ignoreAudio").checked,ignoreFormInput:document.getElementById("ignoreFormInput").checked,ignoreNotifications:document.getElementById("ignoreNotifications").checked,ignorePinned:document.getElementById("ignorePinned").checked};chrome.storage.sync.set(t),showMainStatus("Options saved!")}catch(e){console.error("Error saving options:",e),showMainStatus("Error saving options")}}),document.getElementById("saveScreenshotSettings").addEventListener("click",()=>{try{const e=parseInt(document.getElementById("captureQuality").value,10),t=parseInt(document.getElementById("resizeWidth").value,10),n=parseInt(document.getElementById("resizeHeight").value,10),i=parseFloat(document.getElementById("resizeQuality").value);if(isNaN(e)||e<5||e>100)return void showMainStatus("Capture Quality must be 5-100");if(isNaN(t)||t<100)return void showMainStatus("Resize Width must be at least 100");if(isNaN(n)||n<100)return void showMainStatus("Resize Height must be at least 100");if(isNaN(i)||i<.1||i>1)return void showMainStatus("Resize Quality must be 0.1-1.0");chrome.storage.sync.set({captureQuality:e,resizeWidth:t,resizeHeight:n,resizeQuality:i}),showMainStatus("Screenshot settings saved!")}catch(e){console.error("Error saving screenshot settings:",e),showMainStatus("Error saving settings")}}),document.getElementById("whitelistDomainBtn").addEventListener("click",async()=>{try{const e=await getCurrentTab();if(!e.url.match(/^https?:\/\//))return;const t=new URL(e.url).hostname,n=(await chrome.storage.sync.get(["whitelistedDomains"])).whitelistedDomains||[];if(n.includes(t))showMainStatus(`Domain ${t} already whitelisted`);else{n.push(t),await chrome.storage.sync.set({whitelistedDomains:n});displayWhitelist(n,(await chrome.storage.sync.get(["whitelistedUrls"])).whitelistedUrls||[]),showMainStatus(`Domain ${t} whitelisted!`)}}catch(e){console.error("Error whitelisting domain:",e)}}),document.getElementById("whitelistPageBtn").addEventListener("click",async()=>{try{const e=await getCurrentTab();if(!e.url.match(/^https?:\/\//))return;const t=e.url,n=(await chrome.storage.sync.get(["whitelistedUrls"])).whitelistedUrls||[];if(n.includes(t))showMainStatus("Current page already whitelisted");else{n.push(t),await chrome.storage.sync.set({whitelistedUrls:n});displayWhitelist((await chrome.storage.sync.get(["whitelistedDomains"])).whitelistedDomains||[],n),showMainStatus("Current page whitelisted!")}}catch(e){console.error("Error whitelisting page:",e)}}),document.getElementById("manageDataBtn").addEventListener("click",()=>{chrome.tabs.create({url:chrome.runtime.getURL("data_management.html")}),window.close()}),document.getElementById("configureShortcutsBtn").addEventListener("click",()=>{chrome.tabs.create({url:"chrome://extensions/shortcuts"}),window.close()});