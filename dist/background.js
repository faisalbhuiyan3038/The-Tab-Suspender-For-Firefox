let T=24e5,I=!0,a=null,s={},g={},i={},c={ignoreAudio:!0,ignoreFormInput:!0,ignoreNotifications:!0,ignorePinned:!0,enableScreenshots:!1,captureQuality:50,resizeWidth:1280,resizeHeight:720,resizeQuality:.5,whitelistedDomains:[],whitelistedUrls:[],autoDiscard:!0,rediscardDelay:30};const S=["suspendTime","isEnabled","ignoreAudio","ignoreFormInput","ignoreNotifications","ignorePinned","whitelistedDomains","whitelistedUrls","enableScreenshots","captureQuality","resizeWidth","resizeHeight","resizeQuality","autoDiscard","rediscardDelay"];async function C(){try{const e=await browser.storage.sync.get(S);e.suspendTime&&(T=e.suspendTime*60*1e3),e.isEnabled!==void 0&&(I=e.isEnabled),c={ignoreAudio:e.ignoreAudio??!0,ignoreFormInput:e.ignoreFormInput??!0,ignoreNotifications:e.ignoreNotifications??!0,ignorePinned:e.ignorePinned??!0,enableScreenshots:e.enableScreenshots??!1,captureQuality:e.captureQuality||50,resizeWidth:e.resizeWidth||1280,resizeHeight:e.resizeHeight||720,resizeQuality:e.resizeQuality||.5,whitelistedDomains:e.whitelistedDomains??[],whitelistedUrls:e.whitelistedUrls??[],autoDiscard:e.autoDiscard??!0,rediscardDelay:e.rediscardDelay??30},console.log("Settings loaded/reloaded:",c,`Suspend Time: ${T}`)}catch(e){console.error("Error loading settings:",e)}}async function L(){try{const e=await browser.storage.local.get("suspendedTabs");e.suspendedTabs&&(s=e.suspendedTabs)}catch(e){console.error("Error loading suspended tabs:",e)}}async function P(){try{const e=await browser.tabs.query({}),r=new Set(e.map(n=>n.id));let t=0;const o=[];for(const n of Object.keys(s)){const u=parseInt(n,10);r.has(u)||e.find(p=>p.id===u)||(console.log(`Cleanup: Removing orphaned entry for non-existent tab ${u}`),delete s[n],o.push("thumbnail_"+u),t++)}t>0&&(w(),o.length>0&&await browser.storage.local.remove(o),console.log(`Cleanup: Removed ${t} orphaned entries from storage.`))}catch(e){console.error("Error during orphan cleanup:",e)}}async function D(){await C(),Object.keys(s).length===0&&await L(),await P(),$()}async function y(e){g[e]&&(clearTimeout(g[e]),delete g[e]);try{if((await browser.tabs.get(e)).url.startsWith(browser.runtime.getURL("suspended.html")))return;I&&e!==a&&(g[e]&&clearTimeout(g[e]),g[e]=setTimeout(()=>{R(e)},T))}catch(r){console.error(`Error in resetTabTimer for tab ${e}:`,r)}}async function R(e,r=!1){if(!(!r&&e===a))try{const t=await browser.tabs.get(e);if(t.url.startsWith(browser.runtime.getURL("suspended.html")))return;if(await E(t,r)){console.log(`Tab ${e} is protected, not suspending`);return}s[e]={url:t.url,title:t.title,favIconUrl:t.favIconUrl},w();let n=browser.runtime.getURL("suspended.html")+"?origUrl="+encodeURIComponent(t.url)+"&title="+encodeURIComponent(t.title)+"&favIconUrl="+encodeURIComponent(t.favIconUrl||"")+"&tabId="+e;if(c.enableScreenshots)try{const u=await browser.tabs.captureTab(e,{format:"jpeg",quality:c.captureQuality});await browser.storage.local.set({["temp_img_"+e]:u}),n+="&hasCapture=true",console.log(`Captured screenshot for tab ${e}`)}catch(u){console.error(`Failed to capture tab ${e}:`,u)}return browser.tabs.update(e,{url:n}),c.autoDiscard&&setTimeout(async()=>{try{await browser.tabs.discard(e),console.log(`Discarded suspended tab ${e}`)}catch{}},1500),!0}catch(t){return console.error("Error suspending tab:",t),!1}}browser.tabs.onUpdated.addListener((e,r,t)=>{if(r.status==="complete"&&(t.url.startsWith(browser.runtime.getURL("suspended.html"))||e!==a&&y(e)),r.status==="complete"&&s[e]){const o=s[e];if(t.url===o.url){let n=browser.runtime.getURL("suspended.html")+"?origUrl="+encodeURIComponent(o.url)+"&title="+encodeURIComponent(o.title)+"&favIconUrl="+encodeURIComponent(o.favIconUrl||"")+"&tabId="+e;browser.tabs.update(e,{url:n})}}}),browser.tabs.onActivated.addListener(e=>{const r=a;a=e.tabId,g[a]&&(clearTimeout(g[a]),delete g[a]),i[a]&&(clearTimeout(i[a]),delete i[a]),r&&r!==a&&browser.tabs.get(r).then(t=>{const o=t.url.startsWith(browser.runtime.getURL("suspended.html"));o&&c.autoDiscard?(i[r]&&clearTimeout(i[r]),i[r]=setTimeout(async()=>{try{await browser.tabs.discard(r),console.log(`Re-discarded suspended tab ${r} after inactivity`)}catch{}delete i[r]},c.rediscardDelay*1e3)):o||y(r)}).catch(()=>{})}),browser.windows.onFocusChanged.addListener(e=>{e!==browser.windows.WINDOW_ID_NONE&&browser.tabs.query({active:!0,windowId:e}).then(r=>{if(r[0]){const t=a;a=r[0].id,g[a]&&(clearTimeout(g[a]),delete g[a]),i[a]&&(clearTimeout(i[a]),delete i[a]),t&&t!==a&&browser.tabs.get(t).then(o=>{const n=o.url.startsWith(browser.runtime.getURL("suspended.html"));n&&c.autoDiscard?(i[t]&&clearTimeout(i[t]),i[t]=setTimeout(async()=>{try{await browser.tabs.discard(t),console.log(`Re-discarded suspended tab ${t} after window focus change`)}catch{}delete i[t]},c.rediscardDelay*1e3)):n||y(t)}).catch(()=>{})}})}),browser.runtime.onMessage.addListener(async(e,r)=>{if(e.action==="updateTheme"){browser.tabs.query({}).then(t=>{t.forEach(o=>{s[o.id]&&browser.tabs.sendMessage(o.id,{action:"updateTheme",isDark:e.isDark})})});return}if(e.action==="resumeTab"&&r.tab){const t=e.origUrl,o=r.tab.id;i[o]&&(clearTimeout(i[o]),delete i[o]),s[o]&&(delete s[o],w()),await browser.storage.local.remove(["thumbnail_"+o,"temp_img_"+o]),browser.tabs.update(o,{url:t})}}),browser.storage.onChanged.addListener((e,r)=>{r==="sync"&&S.some(o=>e.hasOwnProperty(o))&&(console.log("Sync settings changed, reloading..."),C().then(()=>{Object.keys(g).forEach(o=>{y(parseInt(o,10))})}))});function $(){browser.tabs.query({}).then(e=>{const r=e.find(t=>t.active);r&&(a=r.id),e.forEach(t=>{!t.active&&!t.url.startsWith(browser.runtime.getURL("suspended.html"))&&y(t.id)})})}browser.contextMenus.create({id:"whitelistDomain",title:"Whitelist this domain",contexts:["page"]}),browser.contextMenus.create({id:"whitelistUrl",title:"Whitelist this page",contexts:["page"]}),browser.contextMenus.create({id:"suspendPage",title:"Suspend This Page",contexts:["page"]}),browser.contextMenus.onClicked.addListener(async(e,r)=>{try{if(e.menuItemId==="whitelistDomain"){const o=new URL(r.url).hostname;if(!c.whitelistedDomains.includes(o)){const n=[...c.whitelistedDomains,o];await browser.storage.sync.set({whitelistedDomains:n}),browser.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Domain Whitelisted",message:`${o} has been added to the whitelist`})}}else if(e.menuItemId==="whitelistUrl"){const t=r.url;if(!c.whitelistedUrls.includes(t)){const o=[...c.whitelistedUrls,t];await browser.storage.sync.set({whitelistedUrls:o}),browser.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Page Whitelisted",message:"This page has been added to the whitelist"})}}else e.menuItemId==="suspendPage"&&await R(r.id,!0)&&browser.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Page Suspended",message:"This page has been suspended"})}catch(t){console.error("Error in context menu action:",t)}});async function E(e,r=!1){if(!e.url.match(/^https?:\/\//))return!0;if(r)return!1;if(c.ignorePinned&&e.pinned)return!0;try{try{const t=new URL(e.url);if(c.whitelistedDomains.includes(t.hostname)||c.whitelistedUrls.includes(e.url))return!0}catch(t){console.error("Error checking whitelist:",t)}if(c.ignoreAudio&&e.audible)return!0;try{const t=await browser.tabs.executeScript(e.id,{code:`
          {
            const formProtection = ${c.ignoreFormInput} &&
              Array.from(document.getElementsByTagName('form')).some(form => {
                const inputs = form.querySelectorAll('input, textarea, select');
                return Array.from(inputs).some(input => input.value !== input.defaultValue);
              });
            const notificationProtection = ${c.ignoreNotifications} &&
              'Notification' in window &&
              Notification.permission === 'granted';
            ({ formProtection, notificationProtection })
          }
        `}),{formProtection:o,notificationProtection:n}=t[0];if(o||n)return!0}catch{return!0}return!1}catch{return!0}}function w(){browser.storage.local.set({suspendedTabs:s})}browser.tabs.onRemoved.addListener(async e=>{i[e]&&(clearTimeout(i[e]),delete i[e]),s[e]&&(delete s[e],w()),await browser.storage.local.remove(["thumbnail_"+e,"temp_img_"+e])}),browser.runtime.onStartup.addListener(()=>{browser.tabs.query({}).then(e=>{e.forEach(r=>{if(s[r.id]&&s[r.id].url===r.url){const t=s[r.id],o=browser.runtime.getURL("suspended.html")+"?origUrl="+encodeURIComponent(t.url)+"&title="+encodeURIComponent(t.title)+"&favIconUrl="+encodeURIComponent(t.favIconUrl||"")+"&tabId="+r.id;browser.tabs.update(r.id,{url:o})}})})}),browser.commands.onCommand.addListener(async e=>{const r=await browser.tabs.query({active:!0,currentWindow:!0});if(r.length===0)return;const t=r[0];switch(e){case"suspend-current-tab":{await R(t.id,!0)&&browser.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Tab Suspended",message:"The current tab has been suspended."});break}case"whitelist-current-page":{try{const o=t.url;if(c.whitelistedUrls.includes(o))browser.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Page Already Whitelisted",message:"This page is already in the whitelist."});else{const n=[...c.whitelistedUrls,o];c.whitelistedUrls=n,await browser.storage.sync.set({whitelistedUrls:n}),browser.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Page Whitelisted",message:"This page has been added to the whitelist."})}}catch(o){console.error("Error whitelisting page:",o)}break}case"unsuspend-current-tab":{if(i[t.id]&&(clearTimeout(i[t.id]),delete i[t.id]),s[t.id]){const o=s[t.id].url;delete s[t.id],w(),await browser.storage.local.remove(["thumbnail_"+t.id,"temp_img_"+t.id]),await browser.tabs.update(t.id,{url:o})}else browser.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Tab Not Suspended",message:"This tab is not currently suspended."});break}}});async function M(){const e=["suspendTime","isEnabled","ignoreAudio","ignoreFormInput","ignoreNotifications","ignorePinned","whitelistedDomains","whitelistedUrls"];try{const r=await browser.storage.local.get(e);if(Object.keys(r).length>0){console.log("Migration: Found old settings in local storage. Migrating to sync...");let t={};for(const o of e)r[o]!==void 0&&(t[o]=r[o]);Object.keys(t).length>0&&(await browser.storage.sync.set(t),console.log("Migration: Successfully moved settings to sync storage.",t),await browser.storage.local.remove(e),console.log("Migration: Cleaned up old settings from local storage."))}else console.log("Migration check: No local settings found to migrate.")}catch(r){console.error("Sync Migration failed:",r)}try{const r=await browser.storage.local.get("suspendedTabs");if(r.suspendedTabs){console.log("Migration: Found old 'suspendedTabs' blob. Migrating to new format...");const t=r.suspendedTabs;let o={},n={};for(const[u,b]of Object.entries(t))if(b&&b.url){const{thumbnail:p,...l}=b;o[u]=l,p&&(n["thumbnail_"+u]=p)}Object.keys(n).length>0&&(await browser.storage.local.set(n),console.log(`Migration: Migrated ${Object.keys(n).length} thumbnails.`)),await browser.storage.local.set({suspendedTabs:o}),console.log("Migration: New text-only 'suspendedTabs' saved. Migration complete."),s=o}else console.log("Migration check: No old 'suspendedTabs' blob found. No local data migration needed.")}catch(r){console.error("Local Tab Storage Migration failed:",r)}}async function N(){try{const e=browser.runtime.getURL("suspended.html");console.log("Current extension base:",e);const r=/^moz-extension:\/\/[^/]+\/suspended\.html\?/,t=await browser.tabs.query({});console.log(`Found ${t.length} total tabs. Checking for suspended pages...`);let o=0;for(const l of t)if(console.log(`Tab ${l.id}: ${l.url?.substring(0,100)}...`),l.url&&r.test(l.url)){console.log(`Found existing suspended tab ${l.id}`);try{const d=new URL(l.url),h=d.searchParams.get("origUrl"),f=d.searchParams.get("title"),U=d.searchParams.get("favIconUrl");if(h){s[l.id]={url:decodeURIComponent(h),title:decodeURIComponent(f||""),favIconUrl:decodeURIComponent(U||"")},o++;const m=e+"?origUrl="+encodeURIComponent(s[l.id].url)+"&title="+encodeURIComponent(s[l.id].title)+"&favIconUrl="+encodeURIComponent(s[l.id].favIconUrl)+"&tabId="+l.id;await browser.tabs.update(l.id,{url:m}),console.log(`Updated tab ${l.id} to new extension URL`)}}catch(d){console.error(`Failed to parse suspended tab URL for tab ${l.id}:`,d)}}if(o>0){w(),console.log(`Recovered ${o} suspended tabs from existing browser tabs.`);return}const n=Object.keys(s).length;if(n===0){console.log("No suspended tabs found to recover (none in tabs, none in storage).");return}console.log(`No browser tabs found, but have ${n} entries in storage. Re-creating tabs...`);const u=Object.entries(s),b={};for(const[l,d]of u)if(!(!d||!d.url))try{const h=e+"?origUrl="+encodeURIComponent(d.url)+"&title="+encodeURIComponent(d.title||"")+"&favIconUrl="+encodeURIComponent(d.favIconUrl||""),f=await browser.tabs.create({url:h,active:!1}),U=h+"&tabId="+f.id;await browser.tabs.update(f.id,{url:U}),b[f.id]={url:d.url,title:d.title||"",favIconUrl:d.favIconUrl||""},console.log(`Re-created suspended tab: old ID ${l} -> new ID ${f.id}: ${d.url}`);try{const m="thumbnail_"+l,v=await browser.storage.local.get(m);v[m]&&(await browser.storage.local.set({["thumbnail_"+f.id]:v[m]}),await browser.storage.local.remove(m),console.log(`Migrated thumbnail from tab ${l} to ${f.id}`))}catch(m){console.error(`Failed to migrate thumbnail for tab ${l}:`,m)}}catch(h){console.error(`Failed to re-create tab for ${d.url}:`,h)}s=b,w();const p=Object.keys(b).length;console.log(`Re-created ${p} suspended tabs from storage.`),p>0&&browser.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Tabs Restored",message:`${p} suspended tab(s) were restored after the extension update.`})}catch(e){console.error("Error recovering suspended tabs:",e)}}browser.runtime.onInstalled.addListener(async e=>{console.log(`Addon event: ${e.reason}`),(e.reason==="update"||e.reason==="install")&&(console.log("Running migration..."),await M(),console.log("Attempting to recover suspended tabs..."),await N()),D()}),browser.runtime.onStartup.addListener(()=>{D(),browser.tabs.query({}).then(e=>{e.forEach(r=>{if(s[r.id]&&s[r.id].url===r.url){const t=s[r.id],o=browser.runtime.getURL("suspended.html")+"?origUrl="+encodeURIComponent(t.url)+"&title="+encodeURIComponent(t.title)+"&favIconUrl="+encodeURIComponent(t.favIconUrl||"")+"&tabId="+r.id;browser.tabs.update(r.id,{url:o})}})})});
