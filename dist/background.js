let U=24e5,S=!0,c=null,a={},E={},i={ignoreAudio:!0,ignoreFormInput:!0,ignoreNotifications:!0,ignorePinned:!0,enableScreenshots:!1,captureQuality:50,resizeWidth:1280,resizeHeight:720,resizeQuality:.5,whitelistedDomains:[],whitelistedUrls:[],autoDiscard:!0,rediscardDelay:30};const d="suspend_tab_",b="discard_tab_",D=["suspendTime","isEnabled","ignoreAudio","ignoreFormInput","ignoreNotifications","ignorePinned","whitelistedDomains","whitelistedUrls","enableScreenshots","captureQuality","resizeWidth","resizeHeight","resizeQuality","autoDiscard","rediscardDelay"];async function h(){try{const e=await chrome.storage.sync.get(D);e.suspendTime&&(U=e.suspendTime*60*1e3),e.isEnabled!==void 0&&(S=e.isEnabled),i={ignoreAudio:e.ignoreAudio??!0,ignoreFormInput:e.ignoreFormInput??!0,ignoreNotifications:e.ignoreNotifications??!0,ignorePinned:e.ignorePinned??!0,enableScreenshots:e.enableScreenshots??!1,captureQuality:e.captureQuality||50,resizeWidth:e.resizeWidth||1280,resizeHeight:e.resizeHeight||720,resizeQuality:e.resizeQuality||.5,whitelistedDomains:e.whitelistedDomains??[],whitelistedUrls:e.whitelistedUrls??[],autoDiscard:e.autoDiscard??!0,rediscardDelay:e.rediscardDelay??30},console.log("Settings loaded/reloaded:",i,`Suspend Time: ${U}`)}catch(e){console.error("Error loading settings:",e)}}async function T(){try{const e=await chrome.storage.local.get("suspendedTabs");e.suspendedTabs&&(a=e.suspendedTabs)}catch(e){console.error("Error loading suspended tabs:",e)}}async function y(){await h(),await T(),await P()}async function g(e){const r=d+e;await chrome.alarms.clear(r);try{if((await chrome.tabs.get(e)).url.startsWith(chrome.runtime.getURL("suspended.html")))return;if(S&&e!==c){const o=U/6e4;await chrome.alarms.create(r,{delayInMinutes:o}),console.log(`Created suspend alarm for tab ${e}, will fire in ${o} minutes`)}}catch(t){console.error(`Error in resetTabTimer for tab ${e}:`,t)}}async function v(e){const r=d+e;await chrome.alarms.clear(r)}async function I(e,r){const t=b+e;await chrome.alarms.clear(t);const o=Math.max(r/60,.1);await chrome.alarms.create(t,{delayInMinutes:o})}async function p(e){const r=b+e;await chrome.alarms.clear(r)}chrome.alarms.onAlarm.addListener(async e=>{if(console.log(`Alarm fired: ${e.name}`),e.name.startsWith(d)){const r=parseInt(e.name.replace(d,""),10);await R(r)}else if(e.name.startsWith(b)){const r=parseInt(e.name.replace(b,""),10);try{await chrome.tabs.discard(r),console.log(`Discarded suspended tab ${r} via alarm`)}catch{}}});async function R(e,r=!1){await h(),await T();try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});t&&(c=t.id)}catch{}if(!(!r&&e===c))try{const t=await chrome.tabs.get(e);if(t.url.startsWith(chrome.runtime.getURL("suspended.html")))return;if(await L(t,r)){console.log(`Tab ${e} is protected, not suspending`);return}a[e]={url:t.url,title:t.title,favIconUrl:t.favIconUrl},f();let s=chrome.runtime.getURL("suspended.html")+"?origUrl="+encodeURIComponent(t.url)+"&title="+encodeURIComponent(t.title)+"&favIconUrl="+encodeURIComponent(t.favIconUrl||"")+"&tabId="+e;if(i.enableScreenshots)try{if((await chrome.windows.get(t.windowId)).focused){const l=await chrome.tabs.captureVisibleTab(t.windowId,{format:"jpeg",quality:i.captureQuality});await chrome.storage.local.set({["temp_img_"+e]:l}),s+="&hasCapture=true",console.log(`Captured screenshot for tab ${e}`)}}catch(n){console.error(`Failed to capture tab ${e}:`,n)}return await chrome.tabs.update(e,{url:s}),i.autoDiscard&&setTimeout(async()=>{try{await chrome.tabs.discard(e),console.log(`Discarded suspended tab ${e}`)}catch{}},1500),!0}catch(t){return console.error("Error suspending tab:",t),!1}}chrome.tabs.onUpdated.addListener(async(e,r,t)=>{if(r.status==="complete"&&(t.url.startsWith(chrome.runtime.getURL("suspended.html"))||e!==c&&await g(e)),r.status==="complete"&&a[e]){const o=a[e];if(t.url===o.url){let s=chrome.runtime.getURL("suspended.html")+"?origUrl="+encodeURIComponent(o.url)+"&title="+encodeURIComponent(o.title)+"&favIconUrl="+encodeURIComponent(o.favIconUrl||"")+"&tabId="+e;chrome.tabs.update(e,{url:s})}}}),chrome.tabs.onActivated.addListener(async e=>{const r=c;if(c=e.tabId,await v(c),await p(c),r&&r!==c)try{const o=(await chrome.tabs.get(r)).url.startsWith(chrome.runtime.getURL("suspended.html"));o&&i.autoDiscard?await I(r,i.rediscardDelay):o||await g(r)}catch{}}),chrome.windows.onFocusChanged.addListener(async e=>{if(e!==chrome.windows.WINDOW_ID_NONE)try{const r=await chrome.tabs.query({active:!0,windowId:e});if(r[0]){const t=c;if(c=r[0].id,await v(c),await p(c),t&&t!==c)try{const s=(await chrome.tabs.get(t)).url.startsWith(chrome.runtime.getURL("suspended.html"));s&&i.autoDiscard?await I(t,i.rediscardDelay):s||await g(t)}catch{}}}catch(r){console.error("Error in onFocusChanged:",r)}}),chrome.runtime.onMessage.addListener((e,r,t)=>{if(e.action==="updateTheme"){chrome.tabs.query({}).then(o=>{o.forEach(s=>{a[s.id]&&chrome.tabs.sendMessage(s.id,{action:"updateTheme",isDark:e.isDark}).catch(()=>{})})});return}if(e.action==="resumeTab"&&r.tab){const o=e.origUrl,s=r.tab.id;p(s),a[s]&&(delete a[s],f()),chrome.storage.local.remove(["thumbnail_"+s,"temp_img_"+s]).then(()=>{chrome.tabs.update(s,{url:o})})}}),chrome.storage.onChanged.addListener((e,r)=>{r==="sync"&&D.some(o=>e.hasOwnProperty(o))&&(console.log("Sync settings changed, reloading..."),h().then(async()=>{const o=await chrome.alarms.getAll();for(const s of o)if(s.name.startsWith(d)){const n=parseInt(s.name.replace(d,""),10);await g(n)}}))});async function P(){try{const e=await chrome.tabs.query({}),r=e.find(s=>s.active);r&&(c=r.id);const t=await chrome.alarms.getAll(),o=new Set(t.filter(s=>s.name.startsWith(d)).map(s=>parseInt(s.name.replace(d,""),10)));for(const s of e)!s.active&&!s.url.startsWith(chrome.runtime.getURL("suspended.html"))&&(o.has(s.id)||await g(s.id))}catch(e){console.error("Error in initializeTimers:",e)}}chrome.runtime.onInstalled.addListener(e=>{chrome.contextMenus.create({id:"whitelistDomain",title:"Whitelist this domain",contexts:["page"]}),chrome.contextMenus.create({id:"whitelistUrl",title:"Whitelist this page",contexts:["page"]}),chrome.contextMenus.create({id:"suspendPage",title:"Suspend This Page",contexts:["page"]}),console.log(`Addon event: ${e.reason}`),e.reason==="update"||e.reason==="install"?(console.log("Running migration..."),C().then(()=>(console.log("Attempting to recover suspended tabs..."),M())).then(()=>{y()})):y()}),chrome.runtime.onStartup.addListener(()=>{console.log("Service worker starting up..."),y()}),y(),chrome.contextMenus.onClicked.addListener(async(e,r)=>{await h();try{if(e.menuItemId==="whitelistDomain"){const o=new URL(r.url).hostname;if(!i.whitelistedDomains.includes(o)){const s=[...i.whitelistedDomains,o];await chrome.storage.sync.set({whitelistedDomains:s}),chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Domain Whitelisted",message:`${o} has been added to the whitelist`})}}else if(e.menuItemId==="whitelistUrl"){const t=r.url;if(!i.whitelistedUrls.includes(t)){const o=[...i.whitelistedUrls,t];await chrome.storage.sync.set({whitelistedUrls:o}),chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Page Whitelisted",message:"This page has been added to the whitelist"})}}else e.menuItemId==="suspendPage"&&await R(r.id,!0)&&chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Page Suspended",message:"This page has been suspended"})}catch(t){console.error("Error in context menu action:",t)}});async function L(e,r=!1){if(!e.url.match(/^https?:\/\//))return!0;if(r)return!1;if(i.ignorePinned&&e.pinned)return!0;try{try{const t=new URL(e.url);if(i.whitelistedDomains.includes(t.hostname)||i.whitelistedUrls.includes(e.url))return!0}catch(t){console.error("Error checking whitelist:",t)}if(i.ignoreAudio&&e.audible)return!0;try{const t=await chrome.scripting.executeScript({target:{tabId:e.id},func:(o,s)=>{const n=o&&Array.from(document.getElementsByTagName("form")).some(u=>{const m=u.querySelectorAll("input, textarea, select");return Array.from(m).some(w=>w.value!==w.defaultValue)}),l=s&&"Notification"in window&&Notification.permission==="granted";return{formProtection:n,notificationProtection:l}},args:[i.ignoreFormInput,i.ignoreNotifications]});if(t&&t[0]&&t[0].result){const{formProtection:o,notificationProtection:s}=t[0].result;if(o||s)return!0}}catch{return!0}return!1}catch{return!0}}function f(){chrome.storage.local.set({suspendedTabs:a})}chrome.tabs.onRemoved.addListener(async e=>{await v(e),await p(e),a[e]&&(delete a[e],f()),await chrome.storage.local.remove(["thumbnail_"+e,"temp_img_"+e])}),chrome.commands.onCommand.addListener(async e=>{await h(),await T();const r=await chrome.tabs.query({active:!0,currentWindow:!0});if(r.length===0)return;const t=r[0];switch(e){case"suspend-current-tab":{await R(t.id,!0)&&chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Tab Suspended",message:"The current tab has been suspended."});break}case"whitelist-current-page":{try{const o=t.url;if(i.whitelistedUrls.includes(o))chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Page Already Whitelisted",message:"This page is already in the whitelist."});else{const s=[...i.whitelistedUrls,o];i.whitelistedUrls=s,await chrome.storage.sync.set({whitelistedUrls:s}),chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Page Whitelisted",message:"This page has been added to the whitelist."})}}catch(o){console.error("Error whitelisting page:",o)}break}case"unsuspend-current-tab":{if(await p(t.id),a[t.id]){const o=a[t.id].url;delete a[t.id],f(),await chrome.storage.local.remove(["thumbnail_"+t.id,"temp_img_"+t.id]),await chrome.tabs.update(t.id,{url:o})}else chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Tab Not Suspended",message:"This tab is not currently suspended."});break}}});async function C(){const e=["suspendTime","isEnabled","ignoreAudio","ignoreFormInput","ignoreNotifications","ignorePinned","whitelistedDomains","whitelistedUrls"];try{const r=await chrome.storage.local.get(e);if(Object.keys(r).length>0){console.log("Migration: Found old settings in local storage. Migrating to sync...");let t={};for(const o of e)r[o]!==void 0&&(t[o]=r[o]);Object.keys(t).length>0&&(await chrome.storage.sync.set(t),console.log("Migration: Successfully moved settings to sync storage.",t),await chrome.storage.local.remove(e),console.log("Migration: Cleaned up old settings from local storage."))}else console.log("Migration check: No local settings found to migrate.")}catch(r){console.error("Sync Migration failed:",r)}try{const r=await chrome.storage.local.get("suspendedTabs");if(r.suspendedTabs){console.log("Migration: Found old 'suspendedTabs' blob. Migrating to new format...");const t=r.suspendedTabs;let o={},s={};for(const[n,l]of Object.entries(t))if(l&&l.url){const{thumbnail:u,...m}=l;o[n]=m,u&&(s["thumbnail_"+n]=u)}Object.keys(s).length>0&&(await chrome.storage.local.set(s),console.log(`Migration: Migrated ${Object.keys(s).length} thumbnails.`)),await chrome.storage.local.set({suspendedTabs:o}),console.log("Migration: New text-only 'suspendedTabs' saved. Migration complete."),a=o}else console.log("Migration check: No old 'suspendedTabs' blob found. No local data migration needed.")}catch(r){console.error("Local Tab Storage Migration failed:",r)}}async function M(){try{const e=/^chrome-extension:\/\/[^/]+\/suspended\.html\?/,r=chrome.runtime.getURL("suspended.html");console.log("Current extension base:",r),console.log("Looking for pattern:",e);const t=await chrome.tabs.query({});console.log(`Found ${t.length} total tabs. Checking for suspended pages...`);let o=0;for(const s of t)if(console.log(`Tab ${s.id}: ${s.url?.substring(0,100)}...`),s.url&&e.test(s.url)){console.log(`Found suspended tab ${s.id}`);try{const n=new URL(s.url),l=n.searchParams.get("origUrl"),u=n.searchParams.get("title"),m=n.searchParams.get("favIconUrl");if(l){a[s.id]={url:decodeURIComponent(l),title:decodeURIComponent(u||""),favIconUrl:decodeURIComponent(m||"")},o++,console.log(`Recovered tab ${s.id}: ${l}`);const w=r+"?origUrl="+encodeURIComponent(a[s.id].url)+"&title="+encodeURIComponent(a[s.id].title)+"&favIconUrl="+encodeURIComponent(a[s.id].favIconUrl)+"&tabId="+s.id;await chrome.tabs.update(s.id,{url:w}),console.log(`Updated tab ${s.id} to new extension URL`)}}catch(n){console.error(`Failed to parse suspended tab URL for tab ${s.id}:`,n)}}o>0?(f(),console.log(`Recovered ${o} suspended tabs after addon update.`)):console.log("No suspended tabs found to recover.")}catch(e){console.error("Error recovering suspended tabs:",e)}}
