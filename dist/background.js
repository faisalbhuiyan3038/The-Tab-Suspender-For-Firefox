let SUSPEND_TIME=24e5,isEnabled=!0,activeTabId=null,suspendedTabs={},discardTimers={},settings={ignoreAudio:!0,ignoreFormInput:!0,ignoreNotifications:!0,ignorePinned:!0,enableScreenshots:!1,captureQuality:50,resizeWidth:1280,resizeHeight:720,resizeQuality:.5,whitelistedDomains:[],whitelistedUrls:[],autoDiscard:!0,rediscardDelay:30};const SUSPEND_ALARM_PREFIX="suspend_tab_",DISCARD_ALARM_PREFIX="discard_tab_",SYNC_SETTINGS_KEYS=["suspendTime","isEnabled","ignoreAudio","ignoreFormInput","ignoreNotifications","ignorePinned","whitelistedDomains","whitelistedUrls","enableScreenshots","captureQuality","resizeWidth","resizeHeight","resizeQuality","autoDiscard","rediscardDelay"];async function loadSettings(){try{const e=await chrome.storage.sync.get(SYNC_SETTINGS_KEYS);e.suspendTime&&(SUSPEND_TIME=60*e.suspendTime*1e3),void 0!==e.isEnabled&&(isEnabled=e.isEnabled),settings={ignoreAudio:e.ignoreAudio??!0,ignoreFormInput:e.ignoreFormInput??!0,ignoreNotifications:e.ignoreNotifications??!0,ignorePinned:e.ignorePinned??!0,enableScreenshots:e.enableScreenshots??!1,captureQuality:e.captureQuality||50,resizeWidth:e.resizeWidth||1280,resizeHeight:e.resizeHeight||720,resizeQuality:e.resizeQuality||.5,whitelistedDomains:e.whitelistedDomains??[],whitelistedUrls:e.whitelistedUrls??[],autoDiscard:e.autoDiscard??!0,rediscardDelay:e.rediscardDelay??30},console.log("Settings loaded/reloaded:",settings,`Suspend Time: ${SUSPEND_TIME}`)}catch(e){console.error("Error loading settings:",e)}}async function loadSuspendedTabs(){try{const e=await chrome.storage.local.get("suspendedTabs");e.suspendedTabs&&(suspendedTabs=e.suspendedTabs)}catch(e){console.error("Error loading suspended tabs:",e)}}async function initialize(){await loadSettings(),await loadSuspendedTabs(),await initializeTimers()}async function resetTabTimer(e){const t="suspend_tab_"+e;await chrome.alarms.clear(t);try{if((await chrome.tabs.get(e)).url.startsWith(chrome.runtime.getURL("suspended.html")))return;if(isEnabled&&e!==activeTabId){const s=SUSPEND_TIME/6e4;await chrome.alarms.create(t,{delayInMinutes:s}),console.log(`Created suspend alarm for tab ${e}, will fire in ${s} minutes`)}}catch(t){console.error(`Error in resetTabTimer for tab ${e}:`,t)}}async function clearTabTimer(e){const t="suspend_tab_"+e;await chrome.alarms.clear(t)}async function setDiscardTimer(e,t){const s="discard_tab_"+e;await chrome.alarms.clear(s);const a=Math.max(t/60,.1);await chrome.alarms.create(s,{delayInMinutes:a})}async function clearDiscardTimer(e){const t="discard_tab_"+e;await chrome.alarms.clear(t)}async function suspendTab(e,t=!1){await loadSettings(),await loadSuspendedTabs();try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e&&(activeTabId=e.id)}catch(e){}if(t||e!==activeTabId)try{const s=await chrome.tabs.get(e);if(s.url.startsWith(chrome.runtime.getURL("suspended.html")))return;if(await shouldProtectTab(s,t))return void console.log(`Tab ${e} is protected, not suspending`);suspendedTabs[e]={url:s.url,title:s.title,favIconUrl:s.favIconUrl},saveSuspendedTabsState();let a=chrome.runtime.getURL("suspended.html")+"?origUrl="+encodeURIComponent(s.url)+"&title="+encodeURIComponent(s.title)+"&favIconUrl="+encodeURIComponent(s.favIconUrl||"")+"&tabId="+e;if(settings.enableScreenshots)try{if((await chrome.windows.get(s.windowId)).focused){const t=await chrome.tabs.captureVisibleTab(s.windowId,{format:"jpeg",quality:settings.captureQuality});await chrome.storage.local.set({["temp_img_"+e]:t}),a+="&hasCapture=true",console.log(`Captured screenshot for tab ${e}`)}}catch(t){console.error(`Failed to capture tab ${e}:`,t)}return await chrome.tabs.update(e,{url:a}),settings.autoDiscard&&setTimeout(async()=>{try{await chrome.tabs.discard(e),console.log(`Discarded suspended tab ${e}`)}catch(e){}},1500),!0}catch(e){return console.error("Error suspending tab:",e),!1}}async function initializeTimers(){try{const e=await chrome.tabs.query({}),t=e.find(e=>e.active);t&&(activeTabId=t.id);const s=await chrome.alarms.getAll(),a=new Set(s.filter(e=>e.name.startsWith("suspend_tab_")).map(e=>parseInt(e.name.replace("suspend_tab_",""),10)));for(const t of e)t.active||t.url.startsWith(chrome.runtime.getURL("suspended.html"))||a.has(t.id)||await resetTabTimer(t.id)}catch(e){console.error("Error in initializeTimers:",e)}}async function shouldProtectTab(e,t=!1){if(!e.url.match(/^https?:\/\//))return!0;if(t)return!1;if(settings.ignorePinned&&e.pinned)return!0;try{try{const t=new URL(e.url);if(settings.whitelistedDomains.includes(t.hostname))return!0;if(settings.whitelistedUrls.includes(e.url))return!0}catch(e){console.error("Error checking whitelist:",e)}if(settings.ignoreAudio&&e.audible)return!0;try{const t=await chrome.scripting.executeScript({target:{tabId:e.id},func:(e,t)=>({formProtection:e&&Array.from(document.getElementsByTagName("form")).some(e=>{const t=e.querySelectorAll("input, textarea, select");return Array.from(t).some(e=>e.value!==e.defaultValue)}),notificationProtection:t&&"Notification"in window&&"granted"===Notification.permission}),args:[settings.ignoreFormInput,settings.ignoreNotifications]});if(t&&t[0]&&t[0].result){const{formProtection:e,notificationProtection:s}=t[0].result;if(e)return!0;if(s)return!0}}catch(e){return!0}return!1}catch(e){return!0}}function saveSuspendedTabsState(){chrome.storage.local.set({suspendedTabs:suspendedTabs})}async function runMigration(){const e=["suspendTime","isEnabled","ignoreAudio","ignoreFormInput","ignoreNotifications","ignorePinned","whitelistedDomains","whitelistedUrls"];try{const t=await chrome.storage.local.get(e);if(Object.keys(t).length>0){console.log("Migration: Found old settings in local storage. Migrating to sync...");let s={};for(const a of e)void 0!==t[a]&&(s[a]=t[a]);Object.keys(s).length>0&&(await chrome.storage.sync.set(s),console.log("Migration: Successfully moved settings to sync storage.",s),await chrome.storage.local.remove(e),console.log("Migration: Cleaned up old settings from local storage."))}else console.log("Migration check: No local settings found to migrate.")}catch(e){console.error("Sync Migration failed:",e)}try{const e=await chrome.storage.local.get("suspendedTabs");if(e.suspendedTabs){console.log("Migration: Found old 'suspendedTabs' blob. Migrating to new format...");const t=e.suspendedTabs;let s={},a={};for(const[e,i]of Object.entries(t))if(i&&i.url){const{thumbnail:t,...n}=i;s[e]=n,t&&(a["thumbnail_"+e]=t)}Object.keys(a).length>0&&(await chrome.storage.local.set(a),console.log(`Migration: Migrated ${Object.keys(a).length} thumbnails.`)),await chrome.storage.local.set({suspendedTabs:s}),console.log("Migration: New text-only 'suspendedTabs' saved. Migration complete."),suspendedTabs=s}else console.log("Migration check: No old 'suspendedTabs' blob found. No local data migration needed.")}catch(e){console.error("Local Tab Storage Migration failed:",e)}}async function recoverSuspendedTabs(){try{const e=/^chrome-extension:\/\/[^/]+\/suspended\.html\?/,t=chrome.runtime.getURL("suspended.html");console.log("Current extension base:",t),console.log("Looking for pattern:",e);const s=await chrome.tabs.query({});console.log(`Found ${s.length} total tabs. Checking for suspended pages...`);let a=0;for(const i of s)if(console.log(`Tab ${i.id}: ${i.url?.substring(0,100)}...`),i.url&&e.test(i.url)){console.log(`Found suspended tab ${i.id}`);try{const e=new URL(i.url),s=e.searchParams.get("origUrl"),n=e.searchParams.get("title"),o=e.searchParams.get("favIconUrl");if(s){suspendedTabs[i.id]={url:decodeURIComponent(s),title:decodeURIComponent(n||""),favIconUrl:decodeURIComponent(o||"")},a++,console.log(`Recovered tab ${i.id}: ${s}`);const e=t+"?origUrl="+encodeURIComponent(suspendedTabs[i.id].url)+"&title="+encodeURIComponent(suspendedTabs[i.id].title)+"&favIconUrl="+encodeURIComponent(suspendedTabs[i.id].favIconUrl)+"&tabId="+i.id;await chrome.tabs.update(i.id,{url:e}),console.log(`Updated tab ${i.id} to new extension URL`)}}catch(e){console.error(`Failed to parse suspended tab URL for tab ${i.id}:`,e)}}a>0?(saveSuspendedTabsState(),console.log(`Recovered ${a} suspended tabs after addon update.`)):console.log("No suspended tabs found to recover.")}catch(e){console.error("Error recovering suspended tabs:",e)}}chrome.alarms.onAlarm.addListener(async e=>{if(console.log(`Alarm fired: ${e.name}`),e.name.startsWith("suspend_tab_")){const t=parseInt(e.name.replace("suspend_tab_",""),10);await suspendTab(t)}else if(e.name.startsWith("discard_tab_")){const t=parseInt(e.name.replace("discard_tab_",""),10);try{await chrome.tabs.discard(t),console.log(`Discarded suspended tab ${t} via alarm`)}catch(e){}}}),chrome.tabs.onUpdated.addListener(async(e,t,s)=>{if("complete"===t.status&&(s.url.startsWith(chrome.runtime.getURL("suspended.html"))||e!==activeTabId&&await resetTabTimer(e)),"complete"===t.status&&suspendedTabs[e]){const t=suspendedTabs[e];if(s.url===t.url){let s=chrome.runtime.getURL("suspended.html")+"?origUrl="+encodeURIComponent(t.url)+"&title="+encodeURIComponent(t.title)+"&favIconUrl="+encodeURIComponent(t.favIconUrl||"")+"&tabId="+e;chrome.tabs.update(e,{url:s})}}}),chrome.tabs.onActivated.addListener(async e=>{const t=activeTabId;if(activeTabId=e.tabId,await clearTabTimer(activeTabId),await clearDiscardTimer(activeTabId),t&&t!==activeTabId)try{const e=(await chrome.tabs.get(t)).url.startsWith(chrome.runtime.getURL("suspended.html"));e&&settings.autoDiscard?await setDiscardTimer(t,settings.rediscardDelay):e||await resetTabTimer(t)}catch(e){}}),chrome.windows.onFocusChanged.addListener(async e=>{if(e!==chrome.windows.WINDOW_ID_NONE)try{const t=await chrome.tabs.query({active:!0,windowId:e});if(t[0]){const e=activeTabId;if(activeTabId=t[0].id,await clearTabTimer(activeTabId),await clearDiscardTimer(activeTabId),e&&e!==activeTabId)try{const t=(await chrome.tabs.get(e)).url.startsWith(chrome.runtime.getURL("suspended.html"));t&&settings.autoDiscard?await setDiscardTimer(e,settings.rediscardDelay):t||await resetTabTimer(e)}catch(e){}}}catch(e){console.error("Error in onFocusChanged:",e)}}),chrome.runtime.onMessage.addListener((e,t,s)=>{if("updateTheme"!==e.action){if("resumeTab"===e.action&&t.tab){const s=e.origUrl,a=t.tab.id;clearDiscardTimer(a),suspendedTabs[a]&&(delete suspendedTabs[a],saveSuspendedTabsState()),chrome.storage.local.remove(["thumbnail_"+a,"temp_img_"+a]).then(()=>{chrome.tabs.update(a,{url:s})})}}else chrome.tabs.query({}).then(t=>{t.forEach(t=>{suspendedTabs[t.id]&&chrome.tabs.sendMessage(t.id,{action:"updateTheme",isDark:e.isDark}).catch(()=>{})})})}),chrome.storage.onChanged.addListener((e,t)=>{if("sync"===t){SYNC_SETTINGS_KEYS.some(t=>e.hasOwnProperty(t))&&(console.log("Sync settings changed, reloading..."),loadSettings().then(async()=>{const e=await chrome.alarms.getAll();for(const t of e)if(t.name.startsWith("suspend_tab_")){const e=parseInt(t.name.replace("suspend_tab_",""),10);await resetTabTimer(e)}}))}}),chrome.runtime.onInstalled.addListener(e=>{chrome.contextMenus.create({id:"whitelistDomain",title:"Whitelist this domain",contexts:["page"]}),chrome.contextMenus.create({id:"whitelistUrl",title:"Whitelist this page",contexts:["page"]}),chrome.contextMenus.create({id:"suspendPage",title:"Suspend This Page",contexts:["page"]}),console.log(`Addon event: ${e.reason}`),"update"===e.reason||"install"===e.reason?(console.log("Running migration..."),runMigration().then(()=>(console.log("Attempting to recover suspended tabs..."),recoverSuspendedTabs())).then(()=>{initialize()})):initialize()}),chrome.runtime.onStartup.addListener(()=>{console.log("Service worker starting up..."),initialize()}),initialize(),chrome.contextMenus.onClicked.addListener(async(e,t)=>{await loadSettings();try{if("whitelistDomain"===e.menuItemId){const e=new URL(t.url).hostname;if(!settings.whitelistedDomains.includes(e)){const t=[...settings.whitelistedDomains,e];await chrome.storage.sync.set({whitelistedDomains:t}),chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Domain Whitelisted",message:`${e} has been added to the whitelist`})}}else if("whitelistUrl"===e.menuItemId){const e=t.url;if(!settings.whitelistedUrls.includes(e)){const t=[...settings.whitelistedUrls,e];await chrome.storage.sync.set({whitelistedUrls:t}),chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Page Whitelisted",message:"This page has been added to the whitelist"})}}else if("suspendPage"===e.menuItemId){await suspendTab(t.id,!0)&&chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Page Suspended",message:"This page has been suspended"})}}catch(e){console.error("Error in context menu action:",e)}}),chrome.tabs.onRemoved.addListener(async e=>{await clearTabTimer(e),await clearDiscardTimer(e),suspendedTabs[e]&&(delete suspendedTabs[e],saveSuspendedTabsState()),await chrome.storage.local.remove(["thumbnail_"+e,"temp_img_"+e])}),chrome.commands.onCommand.addListener(async e=>{await loadSettings(),await loadSuspendedTabs();const t=await chrome.tabs.query({active:!0,currentWindow:!0});if(0===t.length)return;const s=t[0];switch(e){case"suspend-current-tab":await suspendTab(s.id,!0)&&chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Tab Suspended",message:"The current tab has been suspended."});break;case"whitelist-current-page":try{const e=s.url;if(settings.whitelistedUrls.includes(e))chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Page Already Whitelisted",message:"This page is already in the whitelist."});else{const t=[...settings.whitelistedUrls,e];settings.whitelistedUrls=t,await chrome.storage.sync.set({whitelistedUrls:t}),chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Page Whitelisted",message:"This page has been added to the whitelist."})}}catch(e){console.error("Error whitelisting page:",e)}break;case"unsuspend-current-tab":if(await clearDiscardTimer(s.id),suspendedTabs[s.id]){const e=suspendedTabs[s.id].url;delete suspendedTabs[s.id],saveSuspendedTabsState(),await chrome.storage.local.remove(["thumbnail_"+s.id,"temp_img_"+s.id]),await chrome.tabs.update(s.id,{url:e})}else chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"Tab Not Suspended",message:"This tab is not currently suspended."})}});